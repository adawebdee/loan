<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SR Finance ‚Äî Loan Registration</title>
  <meta name="description" content="SR Finance loan registration system - Dark blue theme" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
  <style>
    *{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
    :root{
      --bg:#071017;
      --surface:#0d1a24;
      --text:#e6f0f6;
      --muted:#7a8a99;
      --accent-blue:#0b5ed7;
      --accent-blue-2:#084ab0;
      --success:#27c48c;
      --danger:#ff6b6b;
      --border:rgba(255,255,255,0.04);
      --radius:14px;
      --card-shadow:0 8px 32px rgba(0,0,0,0.5);
      --glass:rgba(255,255,255,0.02);
      --gradient-surface:linear-gradient(180deg,var(--surface),#071422);
      --gradient-header:linear-gradient(90deg,rgba(3,8,12,0.97),rgba(7,18,24,0.97));
      --select-arrow: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="12" height="8" viewBox="0 0 12 8"><path fill="%230b5ed7" d="M6 8L0 0h12z"/></svg>');
    }
    html,body{height:100%}
    body{
      background:linear-gradient(180deg,var(--bg),#021018 160%);
      color:var(--text);
      font-family:'Inter',ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif;
      -webkit-font-smoothing:antialiased;
      min-height:100vh;
      line-height:1.5;
      padding-bottom:48px;
    }

    /* Header */
    header{
      position:sticky;top:0;z-index:80;
      background:var(--gradient-header);
      border-bottom:1px solid var(--border);
      backdrop-filter:blur(12px);
      padding:14px 16px;
      box-shadow:0 6px 24px rgba(3,8,12,0.6);
    }
    .header-inner{max-width:1100px;margin:0 auto;display:flex;align-items:center;justify-content:space-between;gap:12px}
    .brand{display:flex;align-items:center;gap:12px}
    .logo{
      width:48px;height:48px;border-radius:12px;
      background:linear-gradient(135deg,var(--accent-blue),var(--accent-blue-2));
      display:flex;align-items:center;justify-content:center;
      font-weight:800;color:var(--text);font-size:18px;
      box-shadow:0 8px 20px rgba(11,94,215,0.15);
    }
    .brand h1{font-size:18px;margin:0;font-weight:700}
    .brand p{margin:0;color:var(--muted);font-size:13px}
    .header-right{display:flex;gap:10px;align-items:center}
    .no-wrap { white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:220px; display:inline-block; vertical-align:middle; }

    /* Page */
    .page{max-width:1100px;margin:18px auto;padding:0 16px}
    .intro{margin-bottom:22px}
    .intro h2{font-size:26px;color:var(--text);margin-bottom:6px;font-weight:700}
    .intro p{color:var(--muted);font-size:14px}

    /* Cards */
    .card{
      background:var(--gradient-surface);
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow:var(--card-shadow);
      overflow:hidden;
      margin-bottom:20px;
    }
    .card-header{padding:14px 16px;border-bottom:1px solid rgba(255,255,255,0.03)}
    .card-title{font-weight:700;color:var(--accent-blue);font-size:14px;text-transform:uppercase;letter-spacing:0.5px}
    .card-content{padding:18px}

    /* Grid */
    .grid{display:grid;gap:14px}
    .grid-2{grid-template-columns:repeat(2,1fr)}
    .grid-3{grid-template-columns:repeat(3,1fr)}
    @media(max-width:768px){.grid-2,.grid-3{grid-template-columns:1fr}}

    /* Form Elements */
    label{display:block;font-size:13px;color:var(--muted);Margin-bottom:6px;font-weight:600}
    input[type="text"],input[type="tel"],input[type="number"],input[type="date"],select, textarea{
      width:100%;padding:12px 14px;border-radius:12px;
      background:var(--glass);border:1px solid rgba(255,255,255,0.05);
      color:var(--text);font-size:14px;font-family:inherit;
      transition:all 0.15s ease;
    }
    input::placeholder{color:rgba(230,240,246,0.25)}
    input:focus,select:focus,textarea:focus{outline:none;border-color:rgba(11,94,215,0.3);box-shadow:0 0 0 3px rgba(11,94,215,0.08)}
    select option{background:var(--surface);color:var(--text)}

    /* Select dark arrow styling */
    .select-wrap { position:relative; }
    .select-wrap select {
      appearance:none; -webkit-appearance:none; -moz-appearance:none; padding-right:40px;
      background-image: var(--select-arrow);
      background-repeat: no-repeat;
      background-position: right 12px center;
      background-size: 12px 8px;
    }

    /* Date display with calendar icon */
    .date-wrap { position:relative; display:flex; align-items:center; gap:8px; }
    .date-input-display{
      width:100%;
      padding:12px 14px;
      border-radius:12px;
      background:var(--glass);
      border:1px solid rgba(255,255,255,0.05);
      color:var(--text);
      font-weight:700;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:space-between;
      position:relative;
    }
    .calendar-btn{
      background:transparent;border:none;color:var(--accent-blue);cursor:pointer;padding:6px;border-radius:8px;
      display:flex;align-items:center;justify-content:center;
    }
    /* Native date input overlay - transparent but interactive so native calendar shows on click/tap */
    .date-native-input{
      position:absolute;
      inset:0;
      width:100%;
      height:100%;
      opacity:0;
      cursor:pointer;
      border-radius:12px;
      background:transparent;
      color:transparent;
    }

    /* Buttons */
    .btn{
      border:none;cursor:pointer;font-weight:700;border-radius:10px;padding:10px 16px;
      font-family:inherit;font-size:14px;transition:all 0.15s ease;
    }
    .btn-primary{
      background:linear-gradient(135deg,var(--accent-blue),var(--accent-blue-2));
      color:white;box-shadow:0 8px 24px rgba(11,94,215,0.2);
    }
    .btn-ghost{background:transparent;border:1px solid var(--border);color:var(--text)}
    .btn-outline{background:transparent;border:1px solid var(--border);color:var(--text)}
    .btn-outline.active{background:linear-gradient(135deg,var(--accent-blue),var(--accent-blue-2));color:white;border-color:transparent;box-shadow:0 6px 20px rgba(11,94,215,0.2)}
    .btn-full{width:100%;padding:14px;font-size:15px;margin-bottom:28px}
    .btn-sm{padding:8px 12px;font-size:13px}

    /* Amount Buttons */
    .btn-group{display:flex;flex-wrap:wrap;gap:10px;margin-bottom:12px}

    /* Summary Box */
    .summary-box{
      padding:14px;border-radius:12px;margin-top:12px;
      background:linear-gradient(180deg,rgba(255,255,255,0.025),rgba(255,255,255,0.01));
      border:1px solid rgba(255,255,255,0.03);
    }
    .summary-box.border-accent{border-left:4px solid rgba(11,94,215,0.3)}
    .summary-box.border-success{border-left:4px solid rgba(39,196,140,0.3)}
    .summary-row{display:flex;justify-content:space-between;align-items:center;padding:6px 0}
    .summary-row+.summary-row{border-top:1px solid rgba(255,255,255,0.03)}

    /* Text Utilities */
    .text-muted{color:var(--muted)}
    .text-accent{color:var(--accent-blue)}
    .text-success{color:var(--success)}
    .text-danger{color:var(--danger)}
    .text-lg{font-size:18px}
    .text-sm{font-size:13px}
    .font-bold{font-weight:700}
    .font-extrabold{font-weight:800}

    /* Radio Group */
    .radio-group{display:flex;gap:16px;flex-wrap:wrap}
    .radio-label{display:flex;align-items:center;gap:8px;color:var(--muted);font-weight:600;cursor:pointer}
    .radio-label input{accent-color:var(--accent-blue);width:16px;height:16px}

    /* Modal */
    .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.7);backdrop-filter:blur(4px);z-index:200;align-items:center;justify-content:center;padding:20px}
    .modal.show{display:flex}
    .modal-content{width:100%;max-width:640px;background:var(--gradient-surface);border-radius:16px;padding:20px;border:1px solid var(--border);box-shadow:0 20px 60px rgba(0,0,0,0.5)}
    .modal-header{font-weight:800;color:var(--text);margin-bottom:16px;font-size:18px}
    .modal-input{width:100%;padding:12px 14px;border-radius:12px;background:var(--glass);border:1px solid rgba(255,255,255,0.05);color:var(--text);margin-bottom:12px}
    .modal-actions{display:flex;gap:10px;margin-top:16px;justify-content:flex-end}

    /* Prefix List */
    .prefix-list{display:flex;flex-direction:column;gap:8px;max-height:300px;overflow:auto;margin-bottom:12px}
    .prefix-item{display:flex;gap:8px;align-items:center;padding:10px 12px;border-radius:12px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.03)}
    .prefix-item input{flex:1;background:transparent;border:none;color:var(--text);font-weight:700;font-size:14px;padding:4px}
    .prefix-del{
      width:36px;height:36px;border-radius:8px;border:none;cursor:pointer;
      background:transparent;color:var(--danger);font-size:16px;display:flex;align-items:center;justify-content:center;
    }
    .prefix-del:hover{background:rgba(255,92,92,0.08)}

    /* City search results */
    .search-result{padding:10px;border-radius:10px;background:rgba(255,255,255,0.02);margin-bottom:8px;cursor:pointer}
    .search-result:hover{background:rgba(11,94,215,0.06)}

    /* Preview */
    #preview-section{display:none}
    #preview-section.show{display:block}

    /* Hide form when preview shown */
    #form-section.hidden{display:none}

    @media(max-width:520px){
      .card-header{padding:12px}
      .card-content{padding:14px}
      .brand h1{font-size:16px}
      .logo{width:42px;height:42px;font-size:16px}
      .intro h2{font-size:22px}
    }
  </style>
</head>
<body>
  <header>
    <div class="header-inner">
      <div class="brand">
        <div class="logo">SF</div>
        <div>
          <h1>SR Finance</h1>
          <p>Loan Registration System</p>
        </div>
      </div>
      <div class="header-right">
        <button class="btn btn-ghost no-wrap" onclick="handleNewLoan()">+ New Loan</button>
      </div>
    </div>
  </header>

  <main class="page">
    <section id="form-section">
      <div class="intro">
        <h2>Register a Loan</h2>
        <p class="text-muted">Select state and type the city. Click the calendar icon or date to pick a date.</p>
      </div>

      <form id="loanForm" autocomplete="off">
        <!-- Customer Information -->
        <div class="card">
          <div class="card-header"><div class="card-title">Customer Information</div></div>
          <div class="card-content">
            <div class="grid grid-2">
              <div>
                <label>Customer ID Prefix</label>
                <div style="display:flex;gap:8px;align-items:center">
                  <div class="select-wrap" style="flex:1">
                    <select id="prefixSelect"></select>
                  </div>
                  <button type="button" class="btn btn-outline btn-sm" onclick="openPrefixModal()">Manage</button>
                </div>
                <p class="text-muted text-sm" style="margin-top:8px" id="fullIdPreview">Full ID: CUS-2025001</p>
              </div>

              <div>
                <label>Date</label>
                <div class="date-wrap">
                  <div id="dateDisplay" class="date-input-display" role="button" aria-label="Select date" tabindex="0">
                    <span id="dateText">DD MMM YYYY</span>
                    <button type="button" class="calendar-btn" id="calendarBtn" title="Open calendar" aria-label="Open calendar">
                      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <rect x="3" y="5" width="18" height="16" rx="2" stroke="#0b5ed7" stroke-width="1.6" fill="transparent"></rect>
                        <path d="M16 3v4M8 3v4" stroke="#0b5ed7" stroke-width="1.6" stroke-linecap="round"></path>
                      </svg>
                    </button>
                    <!-- Native date input is now overlayed and interactive (transparent) so clicking either the display or icon opens system picker -->
                    <input type="date" id="date" class="date-native-input" />
                  </div>
                </div>
              </div>

              <div>
                <label>Name *</label>
                <input type="text" id="name" placeholder="Enter full name" required />
              </div>

              <div>
                <label>Parent Name *</label>
                <input type="text" id="parentName" placeholder="Parent name" required />
              </div>

              <div>
                <label>Phone *</label>
                <input type="tel" id="phone" placeholder="Phone number" required />
              </div>

              <div>
                <label>Aadhar *</label>
                <input type="text" id="aadhar" inputmode="numeric" placeholder="1234-5678-9012" maxlength="14" required />
              </div>

              <div>
                <label>Address</label>
                <textarea id="address" placeholder="Street, area, landmark" rows="2"></textarea>
              </div>

              <div>
                <label>State</label>
                <div class="select-wrap">
                  <select id="stateSelect"></select>
                </div>
              </div>

              <div style="grid-column:1 / -1">
                <label>City</label>
                <!-- Plain text input for city (no dropdown/datalist) -->
                <input id="cityInput" type="text" placeholder="Type city/town/village" />
              </div>
            </div>
          </div>
        </div>

        <!-- Loan Details -->
        <div class="card">
          <div class="card-header"><div class="card-title">Loan Details</div></div>
          <div class="card-content">
            <div>
              <label>Loan Amount *</label>
              <div class="btn-group">
                <button type="button" class="btn btn-outline" data-amount="5000">‚Çπ5,000</button>
                <button type="button" class="btn btn-outline" data-amount="8000">‚Çπ8,000</button>
                <button type="button" class="btn btn-outline" data-amount="10000">‚Çπ10,000</button>
                <button type="button" class="btn btn-outline" data-amount="15000">‚Çπ15,000</button>
                <button type="button" class="btn btn-outline" data-amount="20000">‚Çπ20,000</button>
                <button type="button" class="btn btn-outline" onclick="openCustomLoanModal()">+ Custom</button>
              </div>
              <input type="number" id="loanAmountInput" placeholder="Enter loan amount" />
            </div>

            <div id="loanDetailsExtra" style="display:none">
              <div class="summary-box" style="margin-top:16px">
                <div class="summary-row">
                  <span class="text-muted">Commission (‚Çπ100 per ‚Çπ5000)</span>
                  <span class="text-danger font-bold" id="commissionFee">‚Çπ0</span>
                </div>
                <div class="summary-row">
                  <span class="text-muted">Customer Receives</span>
                  <span class="text-success font-bold" id="customerReceives">‚Çπ0</span>
                </div>
              </div>

              <div style="margin-top:16px">
                <label>Interest Rate (%)</label>
                <div class="btn-group">
                  <button type="button" class="btn btn-outline" data-interest="10">10</button>
                  <button type="button" class="btn btn-outline" data-interest="15">15</button>
                  <button type="button" class="btn btn-outline" data-interest="20">20</button>
                  <button type="button" class="btn btn-outline" data-interest="25">25</button>
                  <button type="button" class="btn btn-outline" onclick="openCustomInterestModal()">+ Custom</button>
                </div>
                <input type="number" id="interestRateInput" step="0.1" placeholder="Interest (%)" />
                <p class="text-muted text-sm" style="margin-top:8px" id="interestNote"></p>
              </div>

              <div class="summary-box border-accent" style="margin-top:16px">
                <div class="summary-row">
                  <span class="text-muted">Loan Amount</span>
                  <span class="text-lg font-extrabold" id="summaryLoanAmount">‚Çπ0</span>
                </div>
                <div class="summary-row">
                  <span class="text-muted" id="interestLabel">Interest (0%):</span>
                  <span class="text-lg font-extrabold" id="interestAmount">‚Çπ0</span>
                </div>
                <div class="summary-row">
                  <span class="text-muted">Total Payable</span>
                  <span class="text-lg font-extrabold text-accent" id="totalPayable">‚Çπ0</span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Payment Plan -->
        <div class="card" id="paymentPlanCard" style="display:none">
          <div class="card-header"><div class="card-title">Payment Plan</div></div>
          <div class="card-content">
            <div style="margin-bottom:16px">
              <label>Payment Type</label>
              <div class="radio-group">
                <label class="radio-label"><input type="radio" name="paymentType" value="weekly" /> Weekly</label>
                <label class="radio-label"><input type="radio" name="paymentType" value="monthly" checked /> Monthly</label>
              </div>
            </div>

            <div>
              <label>Installment Amount *</label>
              <div class="btn-group">
                <button type="button" class="btn btn-outline" data-installment="500">‚Çπ500</button>
                <button type="button" class="btn btn-outline" data-installment="800">‚Çπ800</button>
                <button type="button" class="btn btn-outline" data-installment="1000">‚Çπ1,000</button>
                <button type="button" class="btn btn-outline" onclick="openCustomInstallmentModal()">+ Custom</button>
              </div>
            </div>

            <div id="installmentSummary" class="summary-box border-success" style="display:none;margin-top:16px">
              <div class="summary-row">
                <span class="text-muted">Installment Amount</span>
                <span class="font-bold" id="displayInstallmentAmount">‚Çπ0</span>
              </div>
              <div class="summary-row">
                <span class="text-muted">Number of Installments</span>
                <span class="font-bold" id="numberOfInstallments">0</span>
              </div>
              <div class="summary-row">
                <span class="text-muted">Frequency</span>
                <span class="font-bold" id="displayFrequency">Monthly</span>
              </div>
            </div>
          </div>
        </div>

        <button type="submit" class="btn btn-primary btn-full">Submit & Generate Preview</button>
      </form>
    </section>

    <!-- Preview Section -->
    <section id="preview-section">
      <div class="card">
        <div class="card-header"><div class="card-title">Customer Preview</div></div>
        <div class="card-content">
          <div class="grid grid-2">
            <div>
              <p class="text-muted text-sm">Customer ID</p>
              <p class="text-lg font-extrabold text-accent" style="margin-top:6px" id="previewCustomerId"></p>
            </div>
            <div>
              <p class="text-muted text-sm">Name</p>
              <p style="margin-top:6px" id="previewName"></p>
            </div>
            <div>
              <p class="text-muted text-sm">Parent Name</p>
              <p style="margin-top:6px" id="previewParentName"></p>
            </div>
            <div>
              <p class="text-muted text-sm">Phone</p>
              <p style="margin-top:6px" id="previewPhone"></p>
            </div>
            <div>
              <p class="text-muted text-sm">Aadhar</p>
              <p style="margin-top:6px" id="previewAadhar"></p>
            </div>
            <div>
              <p class="text-muted text-sm">Address</p>
              <p style="margin-top:6px" id="previewAddress"></p>
            </div>
            <div>
              <p class="text-muted text-sm">State</p>
              <p style="margin-top:6px" id="previewState"></p>
            </div>
            <div>
              <p class="text-muted text-sm">City</p>
              <p style="margin-top:6px" id="previewCity"></p>
            </div>
            <div>
              <p class="text-muted text-sm">Date</p>
              <p style="margin-top:6px" id="previewDate"></p>
            </div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-header"><div class="card-title">Loan Summary</div></div>
        <div class="card-content">
          <div class="grid grid-2">
            <div>
              <p class="text-muted text-sm">Loan Amount</p>
              <p class="text-lg font-extrabold" style="margin-top:8px" id="previewLoanAmount"></p>
              <p class="text-muted text-sm" style="margin-top:12px">Commission Fee</p>
              <p class="text-lg font-extrabold text-danger" style="margin-top:8px" id="previewCommissionFee"></p>
              <p class="text-muted text-sm" style="margin-top:12px">Customer Receives</p>
              <p class="text-lg font-extrabold text-success" style="margin-top:8px" id="previewCustomerReceives"></p>
            </div>
            <div>
              <p class="text-muted text-sm">Interest Rate</p>
              <p class="text-lg font-extrabold" style="margin-top:8px" id="previewInterestRate"></p>
              <p class="text-muted text-sm" style="margin-top:12px">Interest Amount</p>
              <p class="text-lg font-extrabold" style="margin-top:8px" id="previewInterestAmount"></p>
              <p class="text-muted text-sm" style="margin-top:12px">Total Payable</p>
              <p class="text-lg font-extrabold text-accent" style="margin-top:8px" id="previewTotalPayable"></p>
            </div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-header"><div class="card-title">Payment Plan</div></div>
        <div class="card-content">
          <div class="grid grid-3">
            <div class="summary-box">
              <p class="text-muted text-sm">Payment Type</p>
              <p class="font-bold" style="margin-top:8px;text-transform:capitalize" id="previewPaymentType"></p>
            </div>
            <div class="summary-box">
              <p class="text-muted text-sm">Installment</p>
              <p class="font-bold" style="margin-top:8px" id="previewInstallmentAmount"></p>
            </div>
            <div class="summary-box">
              <p class="text-muted text-sm">Number</p>
              <p class="font-bold" style="margin-top:8px" id="previewNumberOfInstallments"></p>
            </div>
          </div>
        </div>
      </div>

      <div style="display:flex;gap:10px;margin-top:16px">
        <button class="btn btn-ghost" onclick="goBack()">‚Üê Back</button>
        <button class="btn btn-primary" id="confirmBtn" onclick="confirmRegistration()">‚úì Confirm Registration</button>
      </div>
    </section>
  </main>

  <!-- Prefix Modal -->
  <div id="prefixModal" class="modal" aria-hidden="true">
    <div class="modal-content">
      <div class="modal-header">Manage ID Prefixes</div>
      <div class="prefix-list" id="prefixList"></div>

      <!-- New prefix input now placed full width under the list; Add and Close buttons are side-by-side -->
      <input type="text" id="newPrefixInput" maxlength="8" placeholder="New prefix (1-8 chars)" class="modal-input" />
      <div class="modal-actions">
        <button class="btn btn-primary" onclick="addPrefix()">Add</button>
        <button class="btn btn-ghost" onclick="closePrefixModal()">Close</button>
      </div>
    </div>
  </div>

  <!-- City Search Modal (optional, kept but not required) -->
  <div id="citySearchModal" class="modal" aria-hidden="true">
    <div class="modal-content">
      <div class="modal-header">Search City / Town / Village</div>
      <input type="text" id="citySearchInput" class="modal-input" placeholder="Type village/town name (optional)" />
      <div style="display:flex;gap:8px;margin-bottom:12px">
        <button class="btn btn-primary" onclick="searchPlacesByQuery()">Search</button>
        <button class="btn btn-ghost" onclick="closeCitySearch()">Close</button>
      </div>
      <div id="citySearchResults" style="max-height:360px;overflow:auto"></div>
    </div>
  </div>

  <!-- Custom Loan Modal -->
  <div id="customLoanModal" class="modal" aria-hidden="true">
    <div class="modal-content">
      <div class="modal-header">Enter Custom Loan Amount</div>
      <input type="number" id="customLoanInput" placeholder="Amount (‚Çπ)" class="modal-input" />
      <div class="modal-actions">
        <button class="btn btn-primary" onclick="submitCustomLoan()">Set Amount</button>
        <button class="btn btn-ghost" onclick="closeCustomLoanModal()">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Custom Interest Modal -->
  <div id="customInterestModal" class="modal" aria-hidden="true">
    <div class="modal-content">
      <div class="modal-header">Custom Interest Rate (%)</div>
      <input type="number" id="customInterestInput" step="0.1" placeholder="Interest %" class="modal-input" />
      <div class="modal-actions">
        <button class="btn btn-primary" onclick="submitCustomInterest()">Set Interest</button>
        <button class="btn btn-ghost" onclick="closeCustomInterestModal()">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Custom Installment Modal -->
  <div id="customInstallmentModal" class="modal" aria-hidden="true">
    <div class="modal-content">
      <div class="modal-header">Enter Custom Installment Amount</div>
      <input type="number" id="customInstallmentInput" placeholder="Amount (‚Çπ)" class="modal-input" />
      <div class="modal-actions">
        <button class="btn btn-primary" onclick="submitCustomInstallment()">Set Amount</button>
        <button class="btn btn-ghost" onclick="closeCustomInstallmentModal()">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Confirmation Modal -->
  <div id="confirmationModal" class="modal" aria-hidden="true">
    <div class="modal-content">
      <div class="modal-header">Registration Saved</div>
      <p class="text-muted" id="confirmationMessage" style="margin-bottom:16px"></p>
      <div style="text-align:right">
        <button class="btn btn-primary" onclick="handleDone()">Done</button>
      </div>
    </div>
  </div>

  <!-- Firebase JS SDK (v8) -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

  <script>
    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyDQlQzo1yVfQOYYgNCrOcqBwLEAXKfZWCE",
      authDomain: "loan-17784.firebaseapp.com",
      databaseURL: "https://loan-17784-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "loan-17784",
      storageBucket: "loan-17784.firebasestorage.app",
      messagingSenderId: "30800980008",
      appId: "1:30800980008:web:9869d2e63a61b2e7022d1d",
      measurementId: "G-TLV6BKKFJG"
    };
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    // Sample PLACES mapping (used when available to populate city suggestions)
    const PLACES = {
      "Tamil Nadu": {
        "Coimbatore": ["Coimbatore","Pollachi","Mettupalayam","Annur","Periyanayakkanpalayam","Sundarapuram","Sulur","Karumathampatti","Valparai","Kinathukadavu","All villages..."],
        "Chennai": ["Chennai","Ambattur","Sholinganallur","Velachery","All villages..."]
      },
      "Andhra Pradesh": {
        "East Godavari": ["Kakinada","Rajahmundry","Pithapuram","All villages..."],
        "Anantapur": ["Anantapur","Dharmavaram","Penukonda","All villages..."]
      },
      "Karnataka": {
        "Bengaluru Urban": ["Bengaluru","Whitefield","Yelahanka","All villages..."],
        "Mysuru": ["Mysuru","Hunsur","Nanjangud","All villages..."]
      }
    };

    // Full states list now used for the State dropdown
    const STATES = [
      "Andhra Pradesh","Arunachal Pradesh","Assam","Bihar","Chhattisgarh","Goa","Gujarat",
      "Haryana","Himachal Pradesh","Jharkhand","Karnataka","Kerala","Madhya Pradesh",
      "Maharashtra","Manipur","Meghalaya","Mizoram","Nagaland","Odisha","Punjab",
      "Rajasthan","Sikkim","Tamil Nadu","Telangana","Tripura","Uttar Pradesh","Uttarakhand",
      "West Bengal","Delhi","Jammu and Kashmir","Ladakh","Puducherry","Andaman and Nicobar Islands",
      "Chandigarh","Dadra and Nagar Haveli and Daman and Diu","Lakshadweep"
    ];

    // App state
    const state = {
      prefixes: JSON.parse(localStorage.getItem('sr_prefixes')) || ['CUS','ABC','LOA'],
      idPrefix: 'CUS',
      customPrefix: '',
      idNumber: parseInt(localStorage.getItem('sr_idNumber')) || 2025001,
      loanAmount: 0,
      interestRate: 0,
      installmentAmount: 0,
      paymentType: 'monthly'
    };

    let previewData = null;
    let nominatimAbort = null;

    document.addEventListener('DOMContentLoaded', () => {
      renderPrefixSelect();
      setupPrefixListener();
      populateStateSelect();
      setupEventListeners();
      setupAadharFormatter();

      // Set today's date by default and display it (user can change)
      const today = new Date();
      const dateEl = document.getElementById('date');
      dateEl.valueAsDate = today;
      updateDateDisplay(today);
    });

    /* Date handling */
    function updateDateDisplay(d){
      if (!(d instanceof Date) || isNaN(d)) {
        document.getElementById('dateText').textContent = 'DD MMM YYYY';
        document.getElementById('date').value = '';
        return;
      }
      const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
      const dd = String(d.getDate()).padStart(2,'0');
      const mon = months[d.getMonth()];
      const yyyy = d.getFullYear();
      document.getElementById('dateText').textContent = `${dd} ${mon} ${yyyy}`;
      document.getElementById('date').valueAsDate = d;
    }

    // open native date picker for accessibility and mobile
    const dateDisplayEl = document.getElementById('dateDisplay');
    const calendarBtn = document.getElementById('calendarBtn');
    function openNativeDatePicker(){
      const dateEl = document.getElementById('date');
      try {
        if (typeof dateEl.showPicker === 'function') {
          dateEl.showPicker();
        } else {
          dateEl.focus();
          dateEl.click();
        }
      } catch {
        dateEl.focus();
        dateEl.click();
      }
    }
    // Trigger picker when clicking display area or calendar icon or pressing Enter/Space while focused
    dateDisplayEl.addEventListener('click', openNativeDatePicker);
    calendarBtn.addEventListener('click', (e) => { e.stopPropagation(); openNativeDatePicker(); });
    dateDisplayEl.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        openNativeDatePicker();
      }
    });
    document.getElementById('date').addEventListener('change', (e) => {
      if (!e.target.value) { updateDateDisplay(null); return; }
      updateDateDisplay(new Date(e.target.value));
    });

    /* Prefix management */
    function renderPrefixSelect(){
      const sel = document.getElementById('prefixSelect');
      sel.innerHTML = state.prefixes.map(p => `<option value="${p}">${p}</option>`).join('') +
                      `<option value="CUSTOM">${state.idPrefix === 'CUSTOM' ? state.customPrefix || 'Custom' : 'Custom'}</option>`;
      sel.value = state.idPrefix === 'CUSTOM' ? 'CUSTOM' : (state.prefixes.includes(state.idPrefix) ? state.idPrefix : state.prefixes[0]);
      updateFullIdPreview();
    }
    function setupPrefixListener(){
      const sel = document.getElementById('prefixSelect');
      sel.addEventListener('change', (e) => {
        if (e.target.value === 'CUSTOM') {
          const entered = prompt('Enter custom prefix (1-8 chars):', state.customPrefix || '');
          if (entered && entered.trim().length > 0 && entered.trim().length <= 8) {
            state.customPrefix = entered.trim().toUpperCase();
            state.idPrefix = 'CUSTOM';
            renderPrefixSelect();
          } else {
            state.idPrefix = state.prefixes[0];
            renderPrefixSelect();
            alert('Invalid prefix. Reverted to default.');
          }
        } else {
          state.idPrefix = e.target.value;
        }
        updateFullIdPreview();
      });
    }
    function updateFullIdPreview(){
      const prefix = state.idPrefix === 'CUSTOM' ? state.customPrefix : state.idPrefix;
      document.getElementById('fullIdPreview').textContent = `Full ID: ${prefix}-${state.idNumber}`;
    }

    /* Prefix modal */
    function openPrefixModal(){ renderPrefixList(); document.getElementById('prefixModal').classList.add('show'); setTimeout(()=>document.getElementById('newPrefixInput').focus(),100); }
    function closePrefixModal(){ document.getElementById('prefixModal').classList.remove('show'); }
    function renderPrefixList(){
      const el=document.getElementById('prefixList'); el.innerHTML='';
      state.prefixes.forEach((p, idx) => {
        const item=document.createElement('div'); item.className='prefix-item';
        const input=document.createElement('input'); input.value=p; input.maxLength=8;
        input.addEventListener('blur', ()=>editPrefix(idx,input.value));
        // delete button with a trash icon for clarity
        const del=document.createElement('button'); del.className='prefix-del';
        del.title='Delete'; del.setAttribute('aria-label','Delete prefix');
        del.innerText='üóë'; // changed delete icon
        del.addEventListener('click', ()=>deletePrefix(idx));
        item.appendChild(input); item.appendChild(del); el.appendChild(item);
      });
    }
    function addPrefix(){
      const v=document.getElementById('newPrefixInput').value.trim().toUpperCase();
      if(!v||v.length>8){alert('Prefix must be 1-8 chars');return;}
      if(state.prefixes.includes(v)){alert('Prefix exists');document.getElementById('newPrefixInput').value='';return;}
      state.prefixes.push(v);
      localStorage.setItem('sr_prefixes', JSON.stringify(state.prefixes));
      renderPrefixSelect();
      renderPrefixList();
      updateFullIdPreview();
      document.getElementById('newPrefixInput').value='';
      // keep focus for quick additions
      setTimeout(()=>document.getElementById('newPrefixInput').focus(),50);
    }
    function editPrefix(idx,val){
      const up=val.trim().toUpperCase();
      if(!up){alert('Cannot be empty'); renderPrefixList(); return;}
      if(state.prefixes.some((x,i)=>x===up && i!==idx)){alert('That prefix exists'); renderPrefixList(); return;}
      state.prefixes[idx]=up; localStorage.setItem('sr_prefixes', JSON.stringify(state.prefixes)); renderPrefixSelect();
    }
    function deletePrefix(idx){
      if(state.prefixes.length===1){alert('At least one prefix must remain'); return;}
      if(!confirm(`Delete prefix "${state.prefixes[idx]}"?`)) return;
      const deleted=state.prefixes.splice(idx,1)[0];
      localStorage.setItem('sr_prefixes', JSON.stringify(state.prefixes));
      renderPrefixSelect(); renderPrefixList();
      if(state.idPrefix===deleted) state.idPrefix=state.prefixes[0];
      updateFullIdPreview();
    }

    /* State & city handling */
    function populateStateSelect(){
      const stateSel = document.getElementById('stateSelect');
      // Use full STATES list (requested)
      stateSel.innerHTML = `<option value="">Select state</option>` + STATES.map(s => `<option value="${s}">${s}</option>`).join('');
      // Ensure city input is plain (no datalist)
      const cityInput = document.getElementById('cityInput');
      cityInput.removeAttribute('list');
      // If additional logic is needed when state changes, it can be added here, but per request we remove the city dropdown behaviour.
    }

    function populateCitySuggestions(stateName){
      // Intentionally left empty: per request, city should be a plain text cell without dropdown.
      // This function remains in case you want to extend behaviour later.
      const input = document.getElementById('cityInput');
      if (input) input.removeAttribute('list');
    }

    /* City deep search (optional) */
    function openCitySearch(){ document.getElementById('citySearchModal').classList.add('show'); document.getElementById('citySearchInput').value=''; document.getElementById('citySearchResults').innerHTML=''; setTimeout(()=>document.getElementById('citySearchInput').focus(),100); }
    function closeCitySearch(){ document.getElementById('citySearchModal').classList.remove('show'); document.getElementById('citySearchResults').innerHTML=''; if(nominatimAbort) nominatimAbort.abort(); }
    async function searchPlacesByQuery(){
      const term = document.getElementById('citySearchInput').value.trim();
      const st = document.getElementById('stateSelect').value || '';
      if (!term) { alert('Enter search term'); return; }
      if (nominatimAbort) nominatimAbort.abort();
      nominatimAbort = new AbortController(); const signal = nominatimAbort.signal;
      const qParts = [term]; if (st) qParts.push(st); qParts.push('India');
      const q = encodeURIComponent(qParts.join(', '));
      const url = `https://nominatim.openstreetmap.org/search?format=json&addressdetails=1&limit=200&q=${q}&accept-language=en`;
      const resultsEl = document.getElementById('citySearchResults');
      resultsEl.innerHTML = `<div class="text-muted">Searching...</div>`;
      try {
        const res = await fetch(url, { signal, headers: { 'Referer': location.origin } });
        if (!res.ok) throw new Error('Nominatim error');
        const items = await res.json();
        if (!items || items.length === 0) { resultsEl.innerHTML = `<div class="text-muted">No results found.</div>`; return; }
        resultsEl.innerHTML = items.map(it => {
          const short = (it.display_name||'').split(',')[0];
          const display = it.display_name||'';
          const type = it.type||'';
          return `<div class="search-result" data-name="${escapeHtml(short)}" data-full="${escapeHtml(display)}" onclick="selectCityFromSearch(this)">
                    <div style="font-weight:700">${escapeHtml(short)}</div>
                    <div class="text-muted" style="margin-top:6px;font-size:13px">${escapeHtml(display)} ‚Äî ${escapeHtml(type)}</div>
                  </div>`;
        }).join('');
      } catch (err) {
        if (err.name === 'AbortError') return;
        resultsEl.innerHTML = `<div class="text-muted">Search failed. Try again.</div>`;
        console.error(err);
      }
    }
    function selectCityFromSearch(el){
      const name = el.getAttribute('data-name') || el.getAttribute('data-full');
      if (!name) return;
      document.getElementById('cityInput').value = name;
      closeCitySearch();
    }

    /* Aadhar formatter */
    function setupAadharFormatter(){
      const a = document.getElementById('aadhar');
      a.addEventListener('input', (e) => {
        const digits = e.target.value.replace(/\D/g,'').slice(0,12);
        let groups = [];
        for(let i=0;i<digits.length;i+=4) groups.push(digits.substr(i,4));
        e.target.value = groups.join('-');
      });
      a.addEventListener('keydown', (e) => {
        const allowed = ['Backspace','ArrowLeft','ArrowRight','Delete','Tab'];
        if (allowed.includes(e.key)) return;
        if (/^\d$/.test(e.key)) return;
        e.preventDefault();
      });
    }

    /* Loan/payment logic & UI */
    function setupEventListeners(){
      // loan amount presets
      document.querySelectorAll('[data-amount]').forEach(btn => btn.addEventListener('click', () => setLoanAmount(Number(btn.dataset.amount))));
      document.getElementById('loanAmountInput').addEventListener('input', (e)=> { const v=Number(e.target.value); if(v>0) setLoanAmount(v); });

      // interest choices
      document.querySelectorAll('[data-interest]').forEach(btn => btn.addEventListener('click', () => setInterestRate(Number(btn.dataset.interest))));
      document.getElementById('interestRateInput').addEventListener('input', (e)=> { const v=Number(e.target.value); if(!isNaN(v)&&v>=0){ state.interestRate=v; updateInterestButtons(); calculateTotals(); }});

      // installment
      document.querySelectorAll('[data-installment]').forEach(btn => btn.addEventListener('click', () => setInstallmentAmount(Number(btn.dataset.installment))));

      // payment type
      document.querySelectorAll('input[name="paymentType"]').forEach(r => r.addEventListener('change',(e)=>{ state.paymentType=e.target.value; document.getElementById('displayFrequency').textContent = state.paymentType.charAt(0).toUpperCase()+state.paymentType.slice(1); }));

      // form submit
      document.getElementById('loanForm').addEventListener('submit', handleSubmit);

      // modal close on backdrop click
      document.querySelectorAll('.modal').forEach(m => m.addEventListener('click', e => { if (e.target === m) m.classList.remove('show'); }));
    }

    function setLoanAmount(amount){ state.loanAmount=amount; document.getElementById('loanAmountInput').value=amount; document.querySelectorAll('[data-amount]').forEach(b=>b.classList.toggle('active',Number(b.dataset.amount)===amount)); const auto=calculateInterestRate(amount); setInterestRate(auto); document.getElementById('loanDetailsExtra').style.display='block'; document.getElementById('paymentPlanCard').style.display='block'; calculateTotals(); }
    function calculateInterestRate(amount){ if(amount<=5000) return 25; if(amount<=10000) return 20; if(amount<=20000) return 15; return 10; }
    function setInterestRate(rate){ state.interestRate=rate; document.getElementById('interestRateInput').value=rate; updateInterestButtons(); calculateTotals(); }
    function updateInterestButtons(){ document.querySelectorAll('[data-interest]').forEach(b=>b.classList.toggle('active',Number(b.dataset.interest)===state.interestRate)); }
    function setInstallmentAmount(amount){ state.installmentAmount=amount; document.querySelectorAll('[data-installment]').forEach(b=>b.classList.toggle('active',Number(b.dataset.installment)===amount)); document.getElementById('displayInstallmentAmount').textContent=`‚Çπ${amount.toLocaleString()}`; document.getElementById('installmentSummary').style.display='block'; calculateTotals(); }
    function calculateTotals(){ const loanAmount=state.loanAmount; const interestRate=state.interestRate; const commissionFee=Math.floor(loanAmount/5000)*100; const customerReceives=Math.max(0,loanAmount-commissionFee); const interestAmount=(loanAmount*interestRate)/100; const totalPayable=loanAmount+interestAmount; document.getElementById('commissionFee').textContent=`‚Çπ${commissionFee.toLocaleString()}`; document.getElementById('customerReceives').textContent=`‚Çπ${customerReceives.toLocaleString()}`; document.getElementById('summaryLoanAmount').textContent=`‚Çπ${loanAmount.toLocaleString()}`; document.getElementById('interestLabel').textContent=`Interest (${interestRate}%):`; document.getElementById('interestAmount').textContent=`‚Çπ${interestAmount.toLocaleString()}`; document.getElementById('totalPayable').textContent=`‚Çπ${totalPayable.toLocaleString()}`; document.getElementById('interestNote').textContent=`Auto-suggested: ${calculateInterestRate(loanAmount)}%`; if(state.installmentAmount>0){ const installments=Math.ceil(totalPayable/state.installmentAmount); document.getElementById('numberOfInstallments').textContent=installments; } }

    /* Form handling */
    function handleSubmit(e){ e.preventDefault(); if(!state.loanAmount||state.loanAmount<=0){ alert('Please enter/select a loan amount'); return; } const name=document.getElementById('name').value.trim(); if(!name){ alert('Please enter customer name'); return; } const sel=document.getElementById('prefixSelect').value; if(sel==='CUSTOM') state.idPrefix=state.customPrefix||'CUS'; else state.idPrefix=sel; const city=document.getElementById('cityInput').value.trim(); const dateVal=document.getElementById('date').value||''; const data={ customerId:`${state.idPrefix === 'CUSTOM' ? state.customPrefix : state.idPrefix}-${state.idNumber}`, name, parentName:document.getElementById('parentName').value.trim(), phone:document.getElementById('phone').value.trim(), aadhar:document.getElementById('aadhar').value.trim(), address:document.getElementById('address').value.trim(), state:document.getElementById('stateSelect').value, city, date:dateVal, loanAmount:state.loanAmount, commissionFee:Math.floor(state.loanAmount/5000)*100, customerReceives:Math.max(0,state.loanAmount-Math.floor(state.loanAmount/5000)*100), interestRate:state.interestRate, interestAmount:(state.loanAmount*state.interestRate)/100, totalPayable:state.loanAmount + (state.loanAmount*state.interestRate)/100, paymentType:state.paymentType, installmentAmount:state.installmentAmount, numberOfInstallments: state.installmentAmount>0 ? Math.ceil((state.loanAmount + (state.loanAmount*state.interestRate)/100)/state.installmentAmount) : 0 }; previewData = data; showPreview(); }

    function showPreview(){ document.getElementById('previewCustomerId').textContent=previewData.customerId; document.getElementById('previewName').textContent=previewData.name; document.getElementById('previewParentName').textContent=previewData.parentName; document.getElementById('previewPhone').textContent=previewData.phone; document.getElementById('previewAadhar').textContent=previewData.aadhar; document.getElementById('previewAddress').textContent=previewData.address; document.getElementById('previewState').textContent=previewData.state; document.getElementById('previewCity').textContent=previewData.city; document.getElementById('previewDate').textContent=previewData.date||'‚Äî'; document.getElementById('previewLoanAmount').textContent=`‚Çπ${previewData.loanAmount.toLocaleString()}`; document.getElementById('previewCommissionFee').textContent=`‚Çπ${previewData.commissionFee.toLocaleString()}`; document.getElementById('previewCustomerReceives').textContent=`‚Çπ${previewData.customerReceives.toLocaleString()}`; document.getElementById('previewInterestRate').textContent=`${previewData.interestRate}%`; document.getElementById('previewInterestAmount').textContent=`‚Çπ${previewData.interestAmount.toLocaleString()}`; document.getElementById('previewTotalPayable').textContent=`‚Çπ${previewData.totalPayable.toLocaleString()}`; document.getElementById('previewPaymentType').textContent=previewData.paymentType; document.getElementById('previewInstallmentAmount').textContent=previewData.installmentAmount>0?`‚Çπ${previewData.installmentAmount.toLocaleString()}`:'‚Äî'; document.getElementById('previewNumberOfInstallments').textContent=previewData.numberOfInstallments; document.getElementById('form-section').classList.add('hidden'); document.getElementById('preview-section').classList.add('show'); window.scrollTo({top:0,behavior:'smooth'}); }

    function goBack(){ document.getElementById('preview-section').classList.remove('show'); document.getElementById('form-section').classList.remove('hidden'); window.scrollTo({top:0,behavior:'smooth'}); }

    async function confirmRegistration(){ const btn=document.getElementById('confirmBtn'); btn.disabled=true; btn.textContent='Saving...'; const data={...previewData, savedAt:Date.now()}; const safeKey=data.customerId.replace(/[.$#[\]/]/g,'_'); try{ await database.ref('customers/'+safeKey).set(data); await database.ref('registrations').push({...data, pushedAt:Date.now()}); state.idNumber++; localStorage.setItem('sr_idNumber', state.idNumber); updateFullIdPreview(); document.getElementById('confirmationMessage').textContent=`Customer ${data.customerId} saved successfully.`; document.getElementById('confirmationModal').classList.add('show'); }catch(err){ console.error('Firebase save error',err); alert('Failed to save to Firebase.'); }finally{ btn.disabled=false; btn.textContent='‚úì Confirm Registration'; } }

    function handleDone(){ document.getElementById('confirmationModal').classList.remove('show'); resetForm(); goBack(); }

    function resetForm(){ document.getElementById('loanForm').reset(); state.loanAmount=0; state.interestRate=0; state.installmentAmount=0; state.paymentType='monthly'; document.getElementById('loanDetailsExtra').style.display='none'; document.getElementById('paymentPlanCard').style.display='none'; document.getElementById('installmentSummary').style.display='none'; document.querySelectorAll('[data-amount],[data-interest],[data-installment]').forEach(b=>b.classList.remove('active')); document.getElementById('displayFrequency').textContent='Monthly'; previewData=null; document.getElementById('stateSelect').value=''; document.getElementById('cityInput').value=''; const today = new Date(); document.getElementById('date').valueAsDate = today; updateDateDisplay(today); }

    function handleNewLoan(){ resetForm(); if(document.getElementById('preview-section').classList.contains('show')) goBack(); window.scrollTo({top:0,behavior:'smooth'}); }

    /* Utilities */
    function escapeHtml(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }
  </script>
</body>
</html>
